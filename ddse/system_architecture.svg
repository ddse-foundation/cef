<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 900">
  <!-- Definitions -->
  <defs>
    <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#555"/>
    </marker>
    <marker id="arrow-purple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#7b1fa2"/>
    </marker>
    <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.2"/>
    </filter>
  </defs>

  <!-- Background -->
  <rect width="100%" height="100%" fill="#f8f9fa"/>
  <text x="500" y="40" text-anchor="middle" font-family="Arial" font-size="24" font-weight="bold" fill="#333">CEF System Architecture (DuckDB + LLM/MCP)</text>

  <!-- Layers Backgrounds -->
  <rect x="50" y="80" width="200" height="780" rx="10" fill="#e3f2fd" stroke="#90caf9" stroke-dasharray="5,5"/>
  <text x="150" y="110" text-anchor="middle" font-family="Arial" font-size="16" fill="#1565c0" font-weight="bold">Client Layer</text>

  <rect x="280" y="80" width="440" height="780" rx="10" fill="#fff" stroke="#ccc"/>
  <text x="500" y="110" text-anchor="middle" font-family="Arial" font-size="16" fill="#333" font-weight="bold">Core Framework</text>

  <rect x="750" y="80" width="200" height="780" rx="10" fill="#f3e5f5" stroke="#ce93d8" stroke-dasharray="5,5"/>
  <text x="850" y="110" text-anchor="middle" font-family="Arial" font-size="16" fill="#7b1fa2" font-weight="bold">Infrastructure / AI</text>

  <!-- Client Components -->
  <g transform="translate(75, 180)">
    <rect width="150" height="60" rx="5" fill="#fff" stroke="#1565c0" stroke-width="2" filter="url(#shadow)"/>
    <text x="75" y="35" text-anchor="middle" font-family="Arial" font-size="14">Benchmark Tests</text>
  </g>

  <g transform="translate(75, 280)">
    <rect width="150" height="60" rx="5" fill="#fff" stroke="#1565c0" stroke-width="2" filter="url(#shadow)"/>
    <text x="75" y="35" text-anchor="middle" font-family="Arial" font-size="14">API Client</text>
  </g>

  <!-- Service Layer -->
  
  <!-- MCP / Agent Orchestrator -->
  <g transform="translate(350, 140)">
    <rect width="300" height="60" rx="5" fill="#f3e5f5" stroke="#8e24aa" stroke-width="2" filter="url(#shadow)"/>
    <text x="150" y="25" text-anchor="middle" font-family="Arial" font-size="14" font-weight="bold">MCP / Agent Layer</text>
    <text x="150" y="45" text-anchor="middle" font-family="Arial" font-size="10">(Orchestration &amp; Tool Routing)</text>
  </g>

  <!-- Indexer -->
  <g transform="translate(350, 230)">
    <rect width="300" height="50" rx="5" fill="#fff3e0" stroke="#e65100" stroke-width="2" filter="url(#shadow)"/>
    <text x="150" y="30" text-anchor="middle" font-family="Arial" font-size="14" font-weight="bold">KnowledgeIndexer</text>
  </g>

  <!-- Retriever -->
  <g transform="translate(350, 300)">
    <rect width="300" height="50" rx="5" fill="#e8f5e9" stroke="#2e7d32" stroke-width="2" filter="url(#shadow)"/>
    <text x="150" y="30" text-anchor="middle" font-family="Arial" font-size="14" font-weight="bold">KnowledgeRetriever</text>
  </g>

  <!-- AI Integration -->
  
  <!-- LLM -->
  <g transform="translate(775, 140)">
    <rect width="150" height="80" rx="5" fill="#fff" stroke="#7b1fa2" stroke-width="2" filter="url(#shadow)"/>
    <text x="75" y="30" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">LLM / Inference</text>
    <text x="75" y="50" text-anchor="middle" font-family="Arial" font-size="10">(VLLM / OpenAI)</text>
    <text x="75" y="65" text-anchor="middle" font-family="Arial" font-size="10" fill="#d81b60">Tool Calling</text>
  </g>

  <!-- Embedding Model -->
  <g transform="translate(775, 260)">
    <rect width="150" height="60" rx="5" fill="#fff" stroke="#7b1fa2" stroke-width="2" filter="url(#shadow)"/>
    <text x="75" y="25" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">Embedding Model</text>
    <text x="75" y="45" text-anchor="middle" font-family="Arial" font-size="10">(Spring AI / Ollama)</text>
  </g>

  <!-- Logic Flow: Client -> Agent (Retrieval) -->
  <line x1="225" y1="310" x2="260" y2="310" stroke="#555" stroke-width="2"/>
  <line x1="260" y1="310" x2="260" y2="170" stroke="#555" stroke-width="2"/>
  <line x1="260" y1="170" x2="350" y2="170" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>
  
  <!-- Benchmark -> Agent (Retrieval) -->
  <line x1="225" y1="210" x2="260" y2="210" stroke="#555" stroke-width="2"/>

  <!-- Client -> Indexer (Direct Ingestion) -->
  <line x1="225" y1="310" x2="280" y2="310" stroke="#555" stroke-width="2"/>
  <line x1="280" y1="310" x2="280" y2="255" stroke="#555" stroke-width="2"/>
  <line x1="280" y1="255" x2="350" y2="255" stroke="#e65100" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="315" y="250" text-anchor="middle" font-family="Arial" font-size="10" fill="#e65100">Ingest</text>

  <!-- Agent <-> LLM (Communication) -->
  <line x1="650" y1="160" x2="775" y2="160" stroke="#7b1fa2" stroke-width="2" marker-end="url(#arrow-purple)"/>
  <line x1="775" y1="190" x2="650" y2="190" stroke="#7b1fa2" stroke-width="2" marker-end="url(#arrow-purple)" stroke-dasharray="5,5"/>
  <text x="712" y="155" text-anchor="middle" font-family="Arial" font-size="10" fill="#7b1fa2">Prompt</text>
  <text x="712" y="185" text-anchor="middle" font-family="Arial" font-size="10" fill="#7b1fa2">Tool Call / Response</text>

  <!-- Agent -> Tools (Retriever ONLY) -->
  <line x1="500" y1="200" x2="500" y2="300" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="510" y="250" text-anchor="middle" font-family="Arial" font-size="10" fill="#555" transform="rotate(90, 510, 250)">Execute Tool</text>

  <!-- Service -> AI (Embeddings) -->
  <!-- Indexer -> AI -->
  <line x1="650" y1="255" x2="775" y2="280" stroke="#7b1fa2" stroke-width="2" marker-end="url(#arrow-purple)" stroke-dasharray="5,5"/>
  
  <!-- Retriever -> AI -->
  <line x1="650" y1="325" x2="775" y2="300" stroke="#7b1fa2" stroke-width="2" marker-end="url(#arrow-purple)" stroke-dasharray="5,5"/>
  
  <text x="712" y="270" text-anchor="middle" font-family="Arial" font-size="10" fill="#7b1fa2">Embed</text>

  <!-- Storage Abstraction -->
  <g transform="translate(320, 380)">
    <rect width="140" height="50" rx="5" fill="#fff3e0" stroke="#ef6c00" stroke-width="2"/>
    <text x="70" y="30" text-anchor="middle" font-family="Arial" font-size="14">ChunkStore</text>
  </g>

  <g transform="translate(540, 380)">
    <rect width="140" height="50" rx="5" fill="#fff3e0" stroke="#ef6c00" stroke-width="2"/>
    <text x="70" y="30" text-anchor="middle" font-family="Arial" font-size="14">GraphStore</text>
  </g>

  <!-- Service -> Storage -->
  <!-- Indexer -> Storage -->
  <line x1="400" y1="280" x2="390" y2="380" stroke="#e65100" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="500" y1="280" x2="600" y2="380" stroke="#e65100" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Retriever -> Storage -->
  <line x1="400" y1="350" x2="390" y2="380" stroke="#2e7d32" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="500" y1="350" x2="600" y2="380" stroke="#2e7d32" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- DuckDB Implementation Container -->
  <rect x="300" y="460" width="400" height="350" rx="10" fill="#fff" stroke="#333" stroke-width="2" stroke-dasharray="5,5"/>
  <text x="500" y="485" text-anchor="middle" font-family="Arial" font-size="14" font-weight="bold" fill="#333">DuckDB Implementation</text>

  <!-- Vector Store Impl -->
  <g transform="translate(320, 510)">
    <rect width="160" height="80" rx="5" fill="#e0f7fa" stroke="#006064" stroke-width="2"/>
    <text x="80" y="30" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">DuckDbChunkStore</text>
    <text x="80" y="50" text-anchor="middle" font-family="Arial" font-size="10">Vector Search</text>
    <text x="80" y="65" text-anchor="middle" font-family="Arial" font-size="10">(Cosine Similarity)</text>
  </g>

  <!-- Graph Store Impl -->
  <g transform="translate(520, 510)">
    <rect width="160" height="80" rx="5" fill="#e8f5e9" stroke="#1b5e20" stroke-width="2"/>
    <text x="80" y="30" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">DuckDbGraphStore</text>
    <text x="80" y="50" text-anchor="middle" font-family="Arial" font-size="10">Dual Persistence</text>
    <text x="80" y="65" text-anchor="middle" font-family="Arial" font-size="10">Coordinator</text>
  </g>

  <!-- In-Memory Graph -->
  <g transform="translate(520, 630)">
    <rect width="160" height="60" rx="5" fill="#f1f8e9" stroke="#33691e" stroke-width="2"/>
    <text x="80" y="25" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">InMemoryGraph</text>
    <text x="80" y="45" text-anchor="middle" font-family="Arial" font-size="10">(JGraphT - O(1) Read)</text>
  </g>

  <!-- JDBC Repos -->
  <g transform="translate(320, 730)">
    <rect width="360" height="50" rx="5" fill="#eceff1" stroke="#455a64" stroke-width="2"/>
    <text x="180" y="30" text-anchor="middle" font-family="Arial" font-size="12" font-weight="bold">JDBC Repositories (Node/Edge/Chunk)</text>
  </g>

  <!-- Connections inside Impl -->
  <line x1="390" y1="430" x2="400" y2="510" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="610" y1="430" x2="600" y2="510" stroke="#555" stroke-width="2" marker-end="url(#arrow)"/>

  <!-- Graph Store to In-Memory -->
  <line x1="600" y1="590" x2="600" y2="630" stroke="#1b5e20" stroke-width="2" marker-end="url(#arrow)"/>
  <text x="645" y="615" text-anchor="middle" font-family="Arial" font-size="10" fill="#1b5e20">Read/Write</text>

  <!-- Persistence Connections -->
  <line x1="400" y1="590" x2="400" y2="730" stroke="#006064" stroke-width="2" marker-end="url(#arrow)"/>
  <line x1="550" y1="590" x2="550" y2="730" stroke="#1b5e20" stroke-width="2" marker-end="url(#arrow)"/>
  
  <!-- Database File -->
  <g transform="translate(775, 720)">
    <path d="M0,15 C0,5 150,5 150,15 L150,65 C150,75 0,75 0,65 Z" fill="#fff" stroke="#333" stroke-width="2" filter="url(#shadow)"/>
    <ellipse cx="75" cy="15" rx="75" ry="10" fill="#fff" stroke="#333" stroke-width="2"/>
    <text x="75" y="45" text-anchor="middle" font-family="Arial" font-size="14" font-weight="bold">DuckDB File</text>
    <text x="75" y="60" text-anchor="middle" font-family="Monospace" font-size="10">cef.db</text>
  </g>

  <line x1="680" y1="755" x2="775" y2="755" stroke="#333" stroke-width="2" marker-end="url(#arrow)"/>

</svg>